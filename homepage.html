<!DOCTYPE html>
<html>

<head>
    <title>E-CUP Chat App</title>
    <link rel="icon" type="image/png" href="./Pictures/logo2.png"> 
    <style>
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            padding: 30px;
            background: linear-gradient(to right, #e2e2e2, #c9d6ff);
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        #header {
            display: flex;
            font-family: 'Helvetica Neue', Arial, sans-serif;
            align-items: center;
            justify-content: center;
            background-color: #FFC594;
            color: black;
            padding: 20px;
            user-select: none;
            pointer-events: none;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        #header img {
            height: 60px;
            margin-right: 5px;
        }

        #header h1 {
            font-size: 2em;
            font-family: 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
        }

        #chatContainer {
            display: flex;
            font-family: 'Helvetica Neue', Arial, sans-serif;
            flex-grow: 1;
            width: 100%;
            gap: 10px;
        }

        #messagesSection {
            flex-grow: 5;
            padding: 10px;
            font-family: 'Helvetica Neue', Arial, sans-serif;
            display: flex;
            flex-direction: column;
            background: #FFC594;
            border-radius: 10px;
            box-shadow: 0 4px 8px white;
            height: 100%;
            box-sizing: border-box;
        }

        #contactName {
            font-size: 1.5em;
            text-align: center;
            color: black;
            user-select: none;
            pointer-events: none;
            margin-bottom: 10px;
            border-bottom: 8px solid white;
        }

        #loggedInUser {
            font-size: 1.5em;
            text-align: center;
            user-select: none;
            pointer-events: none;
            margin-bottom: 10px;
        }

        #userSection {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 10px;
        }

        #logoutBtn {
            margin-top: 5px;
            padding: 10px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            user-select: none;
            display: block;
            width: 100%;
            text-align: center;
            font-size: 1.2em;
        }

        #messages {
            flex-grow: 1;
            overflow-y: auto;
            background: white;
            background: url(pattern.jpeg);
            opacity: 0.6;
            padding: 10px;
            user-select: none;
            margin-bottom: 10px;
            border-radius: 10px;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.1);
        }

        #sendMsg {
            height: 40px;
            display: flex;
            border-radius: 10px;
            background: #F5DEB3;
            user-select: none;
            padding: 10px;
            align-items: center;
        }

        #msgTxt {
            flex-grow: 1;
            padding: 10px;
            border: none;
            border-radius: 10px;
            box-sizing: border-box;
        }

        #msgBtn {
            margin-left: 10px;
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            user-select: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .outer {
            width: 100%;
            margin-top: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .messageContainer {
            display: flex;
            align-items: center;
            flex-grow: 1;
            margin-right: 10px;
        }

        .messageContent {
            display: inline-flex;
            align-items: center;
            padding: 10px;
            border-radius: 10px;
        }

        .me {
            background-color: rgb(0, 26, 255);
            color: white;
        }

        .notMe {
            background-color: #e0e0e0;
            color: black;
        }

        .unknown {
            background-color: #ffcccc;
            text-align: center;
        }

        .deleteBtn {
            padding: 10px;
            background-color: red;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
        }

        .timestamp {
            font-size: 0.8em;
            font-weight: bold;
            color: black;
            margin-bottom: 5px; /* Space between timestamp and message */
        }
    </style>
</head>

<body>
    <div id="header">
        <img src="./Pictures/logo.png" alt="E-CUP Logo">
        <h1>ENTERTAINMENT COMMUNICATION USER PLATFORM</h1>
    </div>

    <div id="messagesSection">
        <div id="userSection">
            <div id="loggedInUser"><b>Logged in as: <span id="loggedUserEmail"></span></b></div>
            <button id="logoutBtn">Log Out</button>
        </div>
        <div id="contactName"><b>CHATS</b></div>
        <div id="messages"></div>
        <div id="sendMsg">
            <input type="text" id="msgTxt" placeholder="ENTER YOUR MSG...">
            <input type="submit" id="msgBtn" value="send" onclick="module.sendMsg()">
        </div>
    </div>

    <script>
        module = {};
    </script>
    <script type="module" src="./homepage.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
        import { getFirestore, getDoc, doc } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
        import { getDatabase, ref, set, onChildAdded, remove, onChildRemoved } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js";

        const firebaseConfig = {
    apiKey: "AIzaSyCrSqLx03G6hZI-XNKMKkTA_bKmFNhwgpQ",
    authDomain: "pt-101chatapp.firebaseapp.com",
    databaseURL: "https://pt-101chatapp-default-rtdb.firebaseio.com",
    projectId: "pt-101chatapp",
    storageBucket: "pt-101chatapp.appspot.com",
    messagingSenderId: "224702149854",
    appId: "1:224702149854:web:5de20b4f86b02ec3493e4f",
    measurementId: "G-0WB3VNLBWX"
  };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth();
        const db = getFirestore();
        const realTimeDb = getDatabase(app);

        // Check authentication state
        onAuthStateChanged(auth, (user) => {
            if (user) {
                const loggedInUserId = user.uid; // Use Firebase user ID
                localStorage.setItem('loggedInUserId', loggedInUserId); // Store user ID in local storage

                // Fetch user data from Firestore
                const docRef = doc(db, "users", loggedInUserId);
                getDoc(docRef).then((docSnap) => {
                    if (docSnap.exists()) {
                        const userData = docSnap.data();
                        document.getElementById('loggedUserEmail').innerText = userData.email;
                    } else {
                        console.log("No document found matching ID");
                    }
                }).catch((error) => {
                    console.log("Error getting document:", error);
                });

                // Load messages from Firebase
                loadMessages();

            } else {
                console.log("No user is signed in");
                window.location.href = 'index.html'; // Redirect to login page if not authenticated
            }
        });

        // Function to load messages
        function loadMessages() {
            onChildAdded(ref(realTimeDb, "messages"), (data) => {
                const msg = data.val();
                const msgDiv = document.createElement("div");
                msgDiv.classList.add("outer");
                msgDiv.id = data.key;

                const timestamp = new Date(parseInt(data.key)).toLocaleTimeString(); // Convert timestamp to readable format
                const timestampDiv = document.createElement("span");
                timestampDiv.className = "timestamp";
                timestampDiv.innerText = timestamp;

                const messageContent = document.createElement("div");
                messageContent.className = "messageContent " + (msg.sender === auth.currentUser.email ? "me" : "notMe");
                messageContent.innerText = msg.sender === auth.currentUser.email ? `you: ${msg.msg}` : `${msg.sender}: ${msg.msg}`;

                const deleteButton = document.createElement("button");
                deleteButton.innerText = "DEL"; // Shortened text
                deleteButton.className = "deleteBtn";
                deleteButton.onclick = () => module.dltMsg(data.key);

                // Create a container for timestamp, message, and button
                const messageContainer = document.createElement("div");
                messageContainer.className = "messageContainer";
                messageContainer.appendChild(messageContent);
                messageContainer.appendChild(timestampDiv); // Add timestamp

                msgDiv.appendChild(messageContainer);
                document.getElementById("messages").appendChild(msgDiv);
            });

            // When message is deleted
            onChildRemoved(ref(realTimeDb, "messages"), (data) => {
                const msgBox = document.getElementById(data.key);
                if (msgBox) {
                    messages.removeChild(msgBox);
                }
            });
        }

        // Log out functionality
        const logoutButton = document.getElementById('logoutBtn');
        logoutButton.addEventListener('click', () => {
            const loggedInUserId = localStorage.getItem('loggedInUserId');
            localStorage.removeItem('loggedInUserId');
            signOut(auth).then(() => {
                console.log("User signed out");
                window.location.href = 'index.html'; // Redirect to login page
            }).catch((error) => {
                console.error('Error signing out:', error);
            });
        });

        // Send message functionality
        module.sendMsg = function sendMsg() {
            const msgTxt = document.getElementById('msgTxt');
            const msg = msgTxt.value;
            if (msg.trim() === "") return; // Prevent sending empty messages
            const timestamp = new Date().getTime();
            set(ref(realTimeDb, "messages/" + timestamp), {
                msg: msg,
                sender: auth.currentUser.email // Use the user's email or any identifier
            });

            msgTxt.value = ""; // Clear the input field after sending
        };

        // Delete message functionality
        module.dltMsg = function dltMsg(key) {
            remove(ref(realTimeDb, "messages/" + key));
        };
    </script>

</body>

</html>